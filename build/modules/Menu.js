// Generated by CoffeeScript 2.0.3
// Wiki Monkey - MediaWiki bot and editor-assistant user script
// Copyright (C) 2011 Dario Giovannetti <dev@dariogiovannetti.net>

// This file is part of Wiki Monkey.

// Wiki Monkey is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.

// Wiki Monkey is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.

// You should have received a copy of the GNU General Public License
// along with Wiki Monkey.  If not, see <http://www.gnu.org/licenses/>.
var CSS;

CSS = require('../../auxiliary/lib.js.generic/dist/CSS');

module.exports = (function() {
  var executeGroupAction, makeChangeMenu, makeGroupAction;

  class exports {
    constructor(WM) {
      this.executeEntryAction = this.executeEntryAction.bind(this);
      this.warnInputNeeded = this.warnInputNeeded.bind(this);
      this.WM = WM;
    }

    _makeUI(page_type, plugins) {
      var Plugin, currId, currMenu, entry, execAll, groupAction, groupActions, i, j, len, m, mainDiv, menuSel, menus, parentId, parentMenu, plugin, pluginInst, ref;
      this.page_type = page_type;
      CSS.addStyleElement("#WikiMonkeyMenu input.margin {margin:0 0.33em 0.33em 0;}");
      mainDiv = $('<div/>').attr('id', 'WikiMonkeyMenu');
      groupActions = {};
      for (i = 0, len = plugins.length; i < len; i++) {
        Plugin = plugins[i];
        plugin = new Plugin(this.WM);
        pluginInst = plugin.conf[`${this.page_type}_menu`];
        // This allows to disable an entry by giving it a menu_entry
        // parameter that evaluates to false
        if (!pluginInst || !pluginInst.length) {
          continue;
        }
        if (plugin.makeUI) {
          groupAction = [this.warnInputNeeded, plugin];
        } else {
          groupAction = [this.executeEntryAction, plugin];
        }
        pluginInst.unshift("WikiMonkeyMenuRoot");
        currId = false;
        for (m = j = 0, ref = pluginInst.length - 1; 0 <= ref ? j < ref : j > ref; m = 0 <= ref ? ++j : --j) {
          parentId = currId;
          currId = pluginInst.slice(0, m + 1).join("-").replace(/ /g, "_");
          // I can't simply do $("#" + currId) because mainDiv
          // hasn't been added to the DOM tree yet
          menuSel = mainDiv.children(`div[id='${currId}']`);
          if (!menuSel.length) {
            currMenu = $("<div/>").attr("id", currId).hide().appendTo(mainDiv);
            groupActions[currId] = [];
            if (m > 0) {
              // I can't simply do $("#" + currId) because mainDiv
              // hasn't been added to the DOM tree yet
              parentMenu = mainDiv.children(`div[id='${parentId}']`);
              $('<input/>').attr('type', 'button').val('<').addClass('margin').click(makeChangeMenu(currMenu, parentMenu)).appendTo(currMenu);
              $('<input/>').attr('type', 'button').val(pluginInst[m]).click(makeGroupAction(groupActions[currId])).appendTo(parentMenu);
              $('<input/>').attr('type', 'button').val('>').addClass('margin').click(makeChangeMenu(parentMenu, currMenu)).appendTo(parentMenu);
            }
          } else {
            currMenu = menuSel.first();
          }
          groupActions[currId].push(groupAction);
        }
        entry = $("<input/>").attr('type', 'button').val(pluginInst[pluginInst.length - 1]).addClass('margin').appendTo(currMenu);
        if (plugin.makeUI) {
          entry.click(this.makeEntryUI(currMenu, plugin));
        } else {
          entry.click(this.makeEntryAction(plugin));
        }
      }
      menus = mainDiv.children();
      if (menus.length) {
        execAll = $('<input/>').attr('type', 'button').val("*").addClass('margin').click(makeGroupAction(groupActions["WikiMonkeyMenuRoot"]));
        // I can't simply do $("#" + currId) because mainDiv
        // hasn't been added to the DOM tree yet
        mainDiv.children("div[id='WikiMonkeyMenuRoot']").first().prepend(execAll);
        menus.first().show();
        return mainDiv[0];
      } else {
        return false;
      }
    }

    makeEntryUI(currMenu, plugin) {
      return (event) => {
        var UI, UIdiv;
        currMenu.hide();
        UIdiv = $('<div/>');
        $('<input/>').attr('type', 'button').val('<').addClass('margin').click(function(event) {
          UIdiv.remove();
          return currMenu.show();
        }).appendTo(UIdiv);
        $('<input/>').attr('type', 'button').val('Execute').click(this.makeEntryAction(plugin)).appendTo(UIdiv);
        UI = plugin.makeUI();
        return UIdiv.append(UI).insertAfter(currMenu);
      };
    }

    makeEntryAction(plugin) {
      return (event) => {
        return this.executeEntryAction(plugin, null);
      };
    }

    executeEntryAction(plugin, callNext) {
      this.WM.Log.logHidden("Plugin: " + plugin.constructor.name);
      return plugin[`main_${this.page_type}`](callNext);
    }

    warnInputNeeded(plugin, callNext) {
      this.WM.Log.logWarning("Plugin " + plugin.constructor.name + " was not executed because it requires input from its interface.");
      if (callNext) {
        return callNext();
      }
    }

  };

  makeChangeMenu = function(currentMenu, changeMenu) {
    return function(event) {
      currentMenu.hide();
      return changeMenu.show();
    };
  };

  makeGroupAction = function(subGroupActions) {
    return function(event) {
      return executeGroupAction(subGroupActions, -1);
    };
  };

  executeGroupAction = function(subGroupActions, id) {
    var callContinue, fid;
    id++;
    if (subGroupActions[id]) {
      fid = subGroupActions[id];
      callContinue = () => {
        return executeGroupAction(subGroupActions, id);
      };
      return fid[0](fid[1], callContinue);
    }
  };

  return exports;

})();
